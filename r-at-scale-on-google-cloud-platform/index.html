<!DOCTYPE html>
<html lang="en-GB">
<head>
    <title>R at scale on the Google Cloud Platform &middot; Mark Edmondson</title>
    <meta name="generator" content="Hugo 0.55.5" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="Mark Edmondson">
    
      <meta name="description" content="Current thinking on what I consider the optimal way to work with R on Google Cloud Platform">
    
    
    <link rel="canonical" href="/r-at-scale-on-google-cloud-platform/"/>
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/github.css" rel="stylesheet" id="theme-stylesheet">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
    
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <meta property="og:title" content="R at scale on the Google Cloud Platform" />
<meta property="og:description" content="Current thinking on what I consider the optimal way to work with R on Google Cloud Platform" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/r-at-scale-on-google-cloud-platform/" />
<meta property="article:published_time" content="2019-02-23T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-02-23T00:00:00&#43;00:00"/>

    
    
<meta itemprop="name" content="R at scale on the Google Cloud Platform">
<meta itemprop="description" content="Current thinking on what I consider the optimal way to work with R on Google Cloud Platform">


<meta itemprop="datePublished" content="2019-02-23T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-02-23T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2607">



<meta itemprop="keywords" content="docker,R,google-compute-engine,cloud-run," />

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="R at scale on the Google Cloud Platform"/>
<meta name="twitter:description" content="Current thinking on what I consider the optimal way to work with R on Google Cloud Platform"/>
<meta name="twitter:site" content="@HoloMarkeD"/>

    
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WFFMBH');</script>


    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>
<body>
<div class="container">


<div id="container">
	<header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo">
          
          <i class="logo" style="background-image: url('/images/greenhand.png')"></i>
          
          <span class="site-title">Mark Edmondson</span>
      </a>
      <nav id="main-nav">
          
          
          <a class="main-nav-link" href="/">Home</a>
          
          
          
          
          
          

          
          <a class="main-nav-link" href="/r-packages/">My R Packages</a>
          

          
          
          
          
          <a class="main-nav-link" href="http://www.markedmondson.me/posts/">Non-code blog</a>
          
          
          
          <a class="main-nav-link" href="https://www.markedmondson.me/static/presentations/">Past Presentations</a>
          
          
      </nav>
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="/images/gde_avatar.jpg"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
              <input type="search" name="q" class="search-form-input" placeholder="Search">
              <button type="submit" class="search-form-submit">
              </button>
              <input type="hidden" name="sitesearch" value="/" />
         </form>
        </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tbody>
          <tr>
          
          
          <td><a class="main-nav-link" href="/">Home</a></td>
          
          
          
          
          
          

          
          <td><a class="main-nav-link" href="/r-packages/">My R Packages</a></td>
          

          
          
          
          
          <td><a class="main-nav-link" href="http://www.markedmondson.me/posts/">Non-code blog</a></td>
          
          
          
          <td><a class="main-nav-link" href="https://www.markedmondson.me/static/presentations/">Past Presentations</a></td>
          
          
          <td>
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
          <input type="search" name="q" class="search-form-input" placeholder="Search">
          <input type="hidden" name="sitesearch" value="/" />
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</header>

   	
   	<div class="outer">
   	
    	<aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      
      <img id="avatar" src="/images/gde_avatar.jpg">
      
      <h2 id="name">Mark Edmondson</h2>
      <h3 id="title">Coding in digital analytics</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Copenhagen, Denmark</span>
      
          <a id="follow" href="https://github.com/MarkEdmondson1234">
              Follow
          </a>
      
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        25
        <span>Posts</span>
      </div>
      <div class="article-info-block">
        
          17
        
        <span>
            Tags
        </span>
      </div>
    </div>
    <div class="profile-block social-links">
      <table>
        <tr>
          
<td><a href="//github.com/MarkEdmondson1234" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>























<td><a href="//youtube.com/MarkEdmondsonAtHome" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>















<td><a href="//linkedin.com/in/markpeteredmondson" target="_blank" title="LinkedIn"><i class="fa fa-linkedin"></i></a></td>















<td><a href="//twitter.com/HoloMarkeD" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>


          <td><a href="/index.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></td>
        </tr>
      </table>
    </div>
  </div>
</aside>

    

    <section id="main">
    
    <article id="page-undefined" class="article article-type-page" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
            <img src="/banners/r-at-scale.png" class="article-banner">
        

        <header class="article-header">
    <a href="/r-at-scale-on-google-cloud-platform/">
    <h1 class="article-title" itemprop="name">
        R at scale on the Google Cloud Platform
    </h1>
    </a>
    <div class="article-meta">

        
        <div class="article-date">
            <i class="fa fa-calendar"></i>
            <time datetime="2019-02-23 00:00:00 &#43;0000 UTC" itemprop="datePublished">2019-02-23</time>
            &middot;
            2607
            words
            &middot;
            13
            minute read
        </div>
        
        

        
            
            
            <div class="article-category">
                <i class="fa fa-tags"></i>
                
                
                <a class="article-category-link" href="/tags/docker">docker</a>
                &middot;
                
                
                <a class="article-category-link" href="/tags/r">R</a>
                &middot;
                
                
                <a class="article-category-link" href="/tags/google-compute-engine">google-compute-engine</a>
                &middot;
                
                
                <a class="article-category-link" href="/tags/cloud-run">cloud-run</a>
                
                
            </div>
            
        
    </div>
</header>

        <div class="article-entry" itemprop="articleBody">
            

<p>This post covers my current thinking on what I consider the optimal way to work with R on the Google Cloud Platform (GCP).  It seems this has developed into my niche, and I get questions about it so would like to be able to point to a URL.</p>

<p>Both R and the GCP rapidly evolve, so this will have to be updated I guess at some point in the future, but even as things stand now you can do some wonderful things with R, and can multiply those out to potentially billions of users with GCP.  The only limit is ambition.</p>

<p>The common scenarios I want to cover are:</p>

<ul>
<li>Scaling a standalone R script</li>
<li>Scaling Shiny apps and R APIs</li>
</ul>

<h2 id="it-always-starts-with-docker">It always starts with Docker</h2>

<p>Docker is the main mechanism to achieve scale on GCP.</p>

<p>It encapsulates code into a unit of computation that can be built on top of, one which doesn&rsquo;t care which language or system that code needs to run.</p>

<p>This means that a lot of the techniques described are not specific to R - you could have components running Python, Java, Rust, Node, whatever is easiest for you.  I do think that Docker&rsquo;s strengths seems to cover R&rsquo;s weaknesses particularly well, but having Docker skills is going to be useful whatever you are doing, and is a good investment in the future.</p>

<p>There is growing support for Docker in R, of which I&rsquo;ll mention:</p>

<ul>
<li><a href="https://www.rocker-project.org/">The Rocker Project</a> is where it all flows from, providing useful R Docker images</li>
<li><a href="http://o2r.info/containerit/index.html">containerit</a> is helpful to quickly generate a Dockerfile from an R script or project</li>
<li><a href="https://richfitz.github.io/stevedore/">steveadore</a> is a Docker client written in R</li>
</ul>

<p>Within GCP containers are fundamental and once you have a Docker image, you will be able to use many of GCP&rsquo;s services both now and in the future, as well as on other cloud providers.  The tools I use day to day with my Docker workflows are:</p>

<ul>
<li><a href="https://cloud.google.com/cloud-build/docs/running-builds/automate-builds">Build Triggers</a> - I never build Docker on my machine, I always commit the Dockerfiles to GitHub and then this service builds them for me.</li>
<li><a href="https://cloud.google.com/container-registry/">Container registry</a> - Once built images are available from here.  They are by default private, and over time I&rsquo;ve built a library of useful images.  Some of these are available <a href="https://console.cloud.google.com/cloud-build/triggers?project=gcer-public&amp;organizationId=1054872852559">publically at this repo</a> (you do need to login though)</li>
</ul>

<p>The above are used within <a href="https://cloudyr.github.io/googleComputeEngineR/reference/gce_vm_template.html">googleComputeEngineR&rsquo;s templates</a>, so as RStudio, Shiny and R APIs can be launched quickly.</p>

<p>This basically constitutes a continuous delivery (CD) basis, so to deploy new code I need but push to GitHub and my script, Shiny app, R API or model are updated automatically.</p>

<h3 id="1-scaling-an-r-script">1. Scaling an R script</h3>

<p>The first scenario is where you have a script that does something cool, but now you need it to say run against more data than you can throw at it locally or don&rsquo;t have the CPU resources.  In that case you can choose to scale either horizontally or vertically.</p>

<h4 id="1a-vertical-scaling-aka-getting-a-bigger-boat">1A - Vertical scaling aka &ldquo;Getting a bigger boat&rdquo;</h4>

<p><img src="/images/bigger-boat.jpg" alt="" /></p>

<p>Vertical scaling is where you just throw more power at the problem.  As R is RAM based, then often the easiest solution is to just run the script on a machine with massive RAM.</p>

<p><em>Pros</em></p>

<ul>
<li>probably run the same code with no changes needed</li>
<li>easy to setup</li>
</ul>

<p><em>Cons</em></p>

<ul>
<li>expensive</li>
<li>may be better to have data in database</li>
</ul>

<p>And it can be massive.  Google Compute Engine offers instances with up to 3.75TB of RAM which can probably eat most jobs. To do so, change the machine type to say <code>n1-ultramem-160</code> that gives you 160 CPU cores as well.  (The <a href="https://cloud.google.com/compute/docs/machine-types#megamem">ultra-mem machine type</a>)</p>

<p>Launching this with googleComputeEngineR:</p>

<pre><code class="language-r">library(googleComputeEngineR)

# this will cost a lot
bigmem &lt;- gce_vm(&quot;big-mem&quot;, template = &quot;rstudio&quot;, predefined_type = &quot;n1-ultramem-160&quot;)
</code></pre>

<p>It will cost you $423 a day, so be ready before you launch such a beast.</p>

<h4 id="dealing-with-data-size">Dealing with data size</h4>

<p>However, it is rare that data is in a format that would directly benefit from this much RAM.</p>

<p>Just reading the data will take time at this volumes, and should not be done via CSV files.</p>

<p>Better alternatives include <a href="https://github.com/apache/arrow/tree/master/r">Apache arrow</a>, <a href="https://blog.rstudio.com/2016/03/29/feather/"><code>library(feather)</code></a> or <a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro.html"><code>data.table()</code></a>.</p>

<p>And if your data is that size, why isn&rsquo;t it in a database?  For most analytics tasks like that I reach for BigQuery, which then follows that perhaps you don&rsquo;t need so much RAM if your code is batching operations on the data. For that you can use <a href="https://bigrquery.r-dbi.org/"><code>bigrquery</code></a> or <a href="http://code.markedmondson.me/bigQueryR/"><code>bigQueryR</code></a>.</p>

<h4 id="1b-horizontal-scaling-aka-the-dunkirk">1B - Horizontal scaling aka &ldquo;The Dunkirk&rdquo;</h4>

<p><img src="/images/dunkirk.jpeg" alt="" /></p>

<p><em>Pros</em></p>

<ul>
<li>Docker image created that is available for other workflows</li>
<li>library(future) interface lets same code work with different scaling strategies like multisession, multicore or multi-instance.</li>
</ul>

<p><em>Cons</em></p>

<ul>
<li>probably have to change your code so it can be done via split-map-reduce</li>
<li>have to write meta code to handle the interface of data and code</li>
<li>Not applicable to some problems that need to calculate on all data at once.</li>
</ul>

<p>This is actually the more common path for me, and its here where Docker starts to come into play.  The idea here is to split up your task into bite sized pieces, run your script on those bits then merge them all back together again, or a split-map-reduce workflow.  Not all data problems can be tackled this way, but I would say most can be.</p>

<p>What appeals most to me here is that each time you build the blocks for a job, you may not have to start from scratch - for instance I often reuse images that say connect to BigQuery, and swap the script over.</p>

<p>To achieve this has become a lot easier in R with the <a href="https://CRAN.R-project.org/package=future">future package</a>, which standardises multicore processing in R, and enables one to take your code and work it on many cores or instances in the cloud.  Again, you may find this easier to do on one big VM with lots of cores, or many small VMs.  The code is similar in both cases, but the setup is not, and make sure to include code to tear down the instances again afterwards.</p>

<p>I have a few examples on the <a href="https://cloudyr.github.io/googleComputeEngineR/articles/massive-parallel.html">googleComputeEngineR website</a> as its a popular application.  A full example from there is shown below:</p>

<pre><code class="language-r">library(future)
library(googleComputeEngineR)

## names for your cluster - just three for this example
vm_names &lt;- c(&quot;vm1&quot;,&quot;vm2&quot;,&quot;vm3&quot;)

my_docker &lt;- gce_tag_container(&quot;custom-image&quot;, project = &quot;my-project&quot;)

## create the cluster using custom docker image
## creates jobs that are creating VMs in background
jobs &lt;- lapply(vm_names, function(x) {
    gce_vm_template(template = &quot;r-base&quot;,
                    predefined_type = &quot;n1-highmem-2&quot;,
                    name = x,
                    dynamic_image = my_docker,
                    wait = FALSE)
                    })
                     
## wait for all the jobs to complete and VMs are ready
vms &lt;- lapply(vm_names, gce_wait)
                     
## set up SSH for the VMs
vms &lt;- lapply(vms, gce_ssh_setup)  # set any settings necessary here for SSH                    

## the Rscript command that will run in the cluster
## customise as needed, this for example sets shared RAM to 13GB
my_rscript &lt;- c(&quot;docker&quot;, 
                &quot;run&quot;, c(&quot;--net=host&quot;,&quot;--shm-size=13G&quot;),
                docker_image, 
                &quot;Rscript&quot;)
                
## create the future cluster
plan(cluster, 
     workers = as.cluster(vms, 
                          docker_image=my_docker,
                          rscript=my_rscript),
                          
## create the list of data to run on the cluster
## here we assume they are in a folder of CSVs
## and there are as many files as VMs to run it upon
my_files &lt;- list.files(&quot;myfolder&quot;)

my_data &lt;- lapply(my_files, read.csv)

## make an expensive function to run asynchronously
cluster_f &lt;- function(my_data, args = 4){
   forecast::forecast(forecast::auto.arima(ts(my_data, frequency = args)))
}

## send to cluster
result &lt;- future::future_lapply(my_data, cluster_f, args = 4) 

## once done this will be TRUE
resolved(result)

## Your list of forecasts are now available
result
</code></pre>

<h4 id="1c-horizontal-kubernetes-aka-jason-and-the-argonauts">1C - Horizontal Kubernetes - aka &ldquo;Jason and the Argonauts&rdquo;</h4>

<p><img src="/images/jason.jpg" alt="" /></p>

<p><em>Pros</em></p>

<ul>
<li>takes advantage of Kubernetes features such as auto-scaling, task queues etc.</li>
<li>potentially cheaper</li>
</ul>

<p><em>Cons</em></p>

<ul>
<li>need to create stateless, idempotent workflows</li>
<li>need to make some kind of message broker that decides which bits of data to work on for each pod.</li>
</ul>

<p>Once you are dealing with clusters of machines and Dockerfiles, the natural next step is Kubernetes.</p>

<p>This is not (yet) facilitated using <code>library(future)</code> so is a bit more difficult to setup if you want to roll your own. I think that in time an R specific platform will evolve that will take advantage of the main benefits such as auto-scaling and preemptive image management, which will be much cheaper in the long run if you need to do this kind of operation many times.  RStudio Server Pro is already offering this via its <a href="https://blog.rstudio.com/2018/11/05/rstudio-rsp-1.2-features/">Job Launcher</a>.</p>

<p>If you are looking to roll your own, the most popular post on this blog at the moment is the <a href="https://code.markedmondson.me/r-on-kubernetes-serverless-shiny-r-apis-and-scheduled-scripts/">R on Kubernetes</a> walk-through of my setup.</p>

<p>As the pods of Kubernetes are usually stateless (I don&rsquo;t know how to do a stateful cluster) then you need to make sure the data bits that each pod operates on is able to work completely separately, and also coordinate which bits have been worked on and which should be used for future. Tamas has a guide on how to set up <a href="http://tamaszilagyi.com/blog/2018/2018-08-06-kubernetes-parallel/">parallelizing R code on Kubernetes</a> which is well worth the read.</p>

<h2 id="2-scaling-r-applications">2. Scaling R applications</h2>

<p>Now I turn to cloud applications of R - you have written your code and want to activate that analysis by providing its results, either in a Shiny interactive visualisation or via an API others can call to get the results.</p>

<h3 id="first-dockerise-your-app">First - Dockerise your app</h3>

<p>The first step is to copy your app folder into a Docker container with all the R libraries you need installed.  From there you are ready to take advantage of almost any cloud providers services.</p>

<p>The Dockerfiles are relatively simple, thanks to <code>rocker/shiny</code>:</p>

<pre><code class="language-docker">FROM rocker/shiny
MAINTAINER Mark Edmondson (r@sunholo.com)

# install R package dependencies
RUN apt-get update &amp;&amp; apt-get install -y \
    libssl-dev \
    ## clean up
    &amp;&amp; apt-get clean \ 
    &amp;&amp; rm -rf /var/lib/apt/lists/ \ 
    &amp;&amp; rm -rf /tmp/downloaded_packages/ /tmp/*.rds
    
## Install packages from CRAN needed for your app
RUN install2.r --error \ 
    -r 'http://cran.rstudio.com' \
    googleAuthR \
    &amp;&amp; Rscript -e &quot;devtools::install_github(c('MarkEdmondson1234/googleAnalyticsR')&quot; \
    ## clean up
    &amp;&amp; rm -rf /tmp/downloaded_packages/ /tmp/*.rds

## assume shiny app is in build folder /shiny
COPY ./shiny/ /srv/shiny-server/myapp/
</code></pre>

<blockquote>
<p>When deploying Shiny apps, the biggest stumbling block I have found is that Shiny requires websocket support.  Check your solution first to see if it can deal with websockets before deployment. For instance, App Engine Flexible or Cloud Functions would be a better serverless solutions if websockets were supported, as it would give you a more managed service.</p>
</blockquote>

<p>If deploying an R API via plumber, the Dockerfile is largely the same thanks to <code>trestletech/plumber</code> taking care of the defaults for you, including serving on port 8000.</p>

<p>Say we have the example plumber script saved to <code>api.R</code>:</p>

<pre><code class="language-r">#* Echo back the input
#* @param msg The message to echo
#* @get /api/echo
function(msg=&quot;&quot;){
  list(msg = paste0(&quot;The message is: '&quot;, msg, &quot;'&quot;))
}
</code></pre>

<p>Then the Dockerfile could look like:</p>

<pre><code class="language-docker">FROM trestletech/plumber

# copy your plumbed R script     
COPY api.R /api.R

# default is to run the plumbed script
CMD [&quot;api.R&quot;]
</code></pre>

<h3 id="2a-low-traffic-r-apps">2A - Low traffic R apps</h3>

<p>If you only have a few users and no existing resources, you could set up a VM that will handle the requests.  In that situation you can just use the <a href="https://cloudyr.github.io/googleComputeEngineR/articles/shiny-app.html"><code>googleComputeEngineR</code> template for Shiny</a>:</p>

<pre><code class="language-r">library(googleComputeEngineR)
## make new Shiny template VM for your self-contained Shiny app
vm &lt;- gce_vm(&quot;myapp&quot;, 
             template = &quot;shiny&quot;,
             predefined_type = &quot;n1-standard-2&quot;,
             dynamic_image = gce_tag_container(&quot;custom-shiny-app&quot;, &quot;your-project&quot;))
</code></pre>

<p>And if you do that, you still have a Docker image which can then easily be moved to other platforms when you are ready to scale.</p>

<p>I always want an API to scale so would suggest it is always deployed to a more flexible solution - autoscaling is the killer feature so you aren&rsquo;t losing requests in high peaks or keeping around spare capacity when you are at traffic lows.</p>

<h3 id="2a1-r-apis-on-cloud-run">2A1 - R APIs on Cloud Run</h3>

<p><em>this is updated from the original blog post in summer 2019</em></p>

<p><em>Now I&rsquo;ve made a package to make R APIs easier to deploy onto Cloud Run - see <a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a> for details!</em></p>

<p><em>Pros</em></p>

<ul>
<li>Scale to billions</li>
<li>Keeps costs low</li>
<li>easy to deploy</li>
</ul>

<p><em>Cons</em></p>

<ul>
<li>Works with stateless apps only, so R APIs, and limited Shiny - see <a href="https://code.markedmondson.me/shiny-cloudrun">https://code.markedmondson.me/shiny-cloudrun</a></li>
</ul>

<p>Now Google has released <a href="https://cloud.run">Cloud Run!</a>  And with that release, I modify my original recommendation for R APIs to be deployed on Kubernetes, to instead use Cloud Run.</p>

<p>Why?  Its so simple.  After you have made your Docker container for your plumber API, you simply point the Cloud run service at the image and you are done.  Hosting, scaling and the rest is all taken care of.</p>

<p>To help demonstrate, I&rsquo;ve made a GitHub report for <a href="https://github.com/MarkEdmondson1234/cloudRunR/">CloudRunR</a> that deploys the demo plumber app.</p>

<p>The only trick to it really is to allow Cloud Run to set the port plumber listens on, which is done via this Dockerfile:</p>

<pre><code>FROM trestletech/plumber
LABEL maintainer=&quot;mark&quot;

COPY [&quot;.&quot;, &quot;./&quot;]

ENTRYPOINT [&quot;R&quot;, &quot;-e&quot;, &quot;pr &lt;- plumber::plumb(commandArgs()[4]); pr$run(host='0.0.0.0', port=as.numeric(Sys.getenv('PORT')))&quot;]
CMD [&quot;api.R&quot;]
</code></pre>

<p>Once the Cloud Build has finished it will give you a Docker URI such as gcr.io/mark-edmondson-gde/cloudrunr:939c04dfe80a1eefed28f9dd59aae5dff5dc1e1e.</p>

<ol>
<li>Go to <a href="https://console.cloud.google.com/run/">https://console.cloud.google.com/run/</a></li>
<li>Create a new service, name it something cool</li>
<li>Put the Docker URI into the Cloud Run field.</li>
<li>Select public endpoint, and limit concurrency to what your app is configured to handle per instance (I chose 8)</li>
</ol>

<p>And thats it. A deployed R API.</p>

<p><img src="/images/cloudrunr.png" alt="" /></p>

<p>You will then get a URL for the API you can use. For this demo app the endpoints are /hello, /echo?msg=&ldquo;my message&rdquo; and /plot (or filter the plot via /plot?spec=setosa)</p>

<ul>
<li><a href="https://cloudrunr-ewjogewawq-uc.a.run.app/hello">https://cloudrunr-ewjogewawq-uc.a.run.app/hello</a></li>
<li><a href="https://cloudrunr-ewjogewawq-uc.a.run.app/echo?msg=my%20message">https://cloudrunr-ewjogewawq-uc.a.run.app/echo?msg=my%20message</a></li>
<li><a href="https://cloudrunr-ewjogewawq-uc.a.run.app/plot">https://cloudrunr-ewjogewawq-uc.a.run.app/plot</a></li>
<li><a href="https://cloudrunr-ewjogewawq-uc.a.run.app/plot?spec=setosa">https://cloudrunr-ewjogewawq-uc.a.run.app/plot?spec=setosa</a></li>
</ul>

<blockquote>
<p>But what about Shiny apps?  Well this is a work in progress and some limited Shiny apps do also work on Cloud Run.  See the <a href="https://code.markedmondson.me/shiny-cloudrun">blog post about running Shiny on Cloud Run</a></p>
</blockquote>

<h3 id="2b-r-apps-on-kubernetes">2B - R apps on Kubernetes</h3>

<p><img src="/images/kubernetes.png" alt="" /></p>

<p><em>Pros</em></p>

<ul>
<li>Scale to billions</li>
<li>Keeps costs low</li>
</ul>

<p><em>Cons</em></p>

<ul>
<li>Minimum useage level required to be better than just deploying on a single VM.</li>
</ul>

<p>Kubernetes will take care of deploying the right number of pods to scale your traffic, and starts to make savings once you are past 3 VMs.  You may already have a kubernetes cluster deployed for other things at your company (its getting very popular with IT teams), in which case you can hitch onto an existing cluster.</p>

<p>Its mainly due to the need of websockets that I recommend going straight to Kubernetes once you have need for more than a couple of Shiny apps, rather than say App Engine flexible.  I have an example of <a href="https://github.com/MarkEdmondson1234/serverless-R-API-appengine">deploying plumber on App Engine flexible</a> that you may favour, but these days since I have a kubernetes cluster already deployed for other things I find it easier to deploy it all on that.</p>

<p>Once setup, deployment is quick via the CLI:</p>

<pre><code class="language-bash">kubectl run shiny1 --image gcr.io/gcer-public/shiny-googleauthrdemo:latest --port 3838
kubectl expose deployment shiny1 --target-port=3838  --type=NodePort
</code></pre>

<p>The trickest thing is the ingress, but once grokked works by uploading some boilerplate yaml:</p>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: r-ingress-nginx
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: / 
    nginx.ingress.kubernetes.io/ssl-redirect: &quot;false&quot;
spec:
  rules:
  - http:
      paths:
      - path: /gar/
      # app deployed to /gar/shiny/
        backend:
          serviceName: shiny1
          servicePort: 3838
</code></pre>

<p>Some more detail is in the <a href="https://code.markedmondson.me/r-on-kubernetes-serverless-shiny-r-apis-and-scheduled-scripts/">Kubernetes blog post</a>.</p>

<h2 id="summary">Summary</h2>

<p>With the introduction of Cloud Run, the options get simpler for R APIs, although in all circumstances the first suggestion is &ldquo;Use Docker!&rdquo;.  Cloud Run is a level of service built on top of Kubernetes, but if you can&rsquo;t use that then &ldquo;Use Kubernetes!&rdquo; is the next byword for scale.</p>

<p>In all cases, having that Docker container gives you the flexibility to swap once the new services comes along.  Cloud Functions and App Engine in particular are the next step in managed services, and perhaps in the future you won&rsquo;t even need to create the Docker image - just upload your code, it builds the Dockerfile for you then deploys.</p>

        </div>
        <footer class="article-footer">
    <a data-url="/r-at-scale-on-google-cloud-platform/" data-id="0a894f8bfc38bfa3c0a450c445ec820d" class="article-share-link">
        <i class="fa fa-share"></i>
        Share
    </a>
    
    <a href="/r-at-scale-on-google-cloud-platform/#disqus_thread" class="article-comment-link">
        Comments
    </a>
    

    <script>
    (function ($) {
        
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
    </script>
</footer>

    </div>

    
<nav id="article-nav">
    
    <a href="/automatic-google-analytics-data-imports-cloud-storage/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">
          Older
      </strong>
      <div class="article-nav-title">Auto Google Analytics Data Imports from Cloud Storage</div>
    </a>
    

    
    <a href="/gago/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">
          Newer
      </strong>
      <div class="article-nav-title">gago: Blazingly fast Google Analytics API downloads with Go</div>
    </a>
    
</nav>


</article>


<section id="comments">
    <div id="disqus_thread">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "markedmondson" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
</section>


    </section>

   	
    	<aside id="sidebar">
    
<div class="widget-wrap">
    <h3 class="widget-title">
        Recents
    </h3>
    <div class="widget">
        <ul id="recent-post">
            
            <li>
                <div class="item-thumbnail">
                    <a href="/shiny-cloudrun/" class="thumbnail">
                    
                        <span style="background-image:url(/banners/shiny-clouds.jpg)" alt="R at scale on the Google Cloud Platform" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-title"><a href="/shiny-cloudrun/" class="title">Shiny on Google Cloud Run - Scale-to-Zero R Web Apps</a></p>
                    <p class="item-date">
                        <time datetime="2020-08-01 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-08-01</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="/datascience-aas/" class="thumbnail">
                    
                        <span style="background-image:url(/banners/piketty-capital.png)" alt="R at scale on the Google Cloud Platform" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-title"><a href="/datascience-aas/" class="title">Online payments for data science apps (DSaaS) using R, Shiny, Firebase, Paddle and Google Cloud Functions</a></p>
                    <p class="item-date">
                        <time datetime="2020-06-28 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-06-28</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="/googleCloudRunner-intro/" class="thumbnail">
                    
                        <span style="background-image:url(/banners/gcp-pyramid.png)" alt="R at scale on the Google Cloud Platform" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-title"><a href="/googleCloudRunner-intro/" class="title">Introducing googleCloudRunner - serverless R on Google Cloud Platform</a></p>
                    <p class="item-date">
                        <time datetime="2020-01-18 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-01-18</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="/gago/" class="thumbnail">
                    
                        <span style="background-image:url(/banners/gago.png)" alt="R at scale on the Google Cloud Platform" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-title"><a href="/gago/" class="title">gago: Blazingly fast Google Analytics API downloads with Go</a></p>
                    <p class="item-date">
                        <time datetime="2019-10-09 00:00:00 &#43;0000 UTC" itemprop="datePublished">2019-10-09</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="/r-at-scale-on-google-cloud-platform/" class="thumbnail">
                    
                        <span style="background-image:url(/banners/r-at-scale.png)" alt="R at scale on the Google Cloud Platform" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-title"><a href="/r-at-scale-on-google-cloud-platform/" class="title">R at scale on the Google Cloud Platform</a></p>
                    <p class="item-date">
                        <time datetime="2019-02-23 00:00:00 &#43;0000 UTC" itemprop="datePublished">2019-02-23</time>
                    </p>
                </div>
            </li>
            
        </ul>
    </div>
</div>


    





    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tags
    </h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/r">
                    R
                </a>
                <span class="category-list-count">20</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/big-query">
                    big-query
                </a>
                <span class="category-list-count">5</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/blogging">
                    blogging
                </a>
                <span class="category-list-count">2</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/cloud-functions">
                    cloud-functions
                </a>
                <span class="category-list-count">3</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/cloud-run">
                    cloud-run
                </a>
                <span class="category-list-count">2</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/docker">
                    docker
                </a>
                <span class="category-list-count">8</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/firebase">
                    firebase
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/google-analytics">
                    google-analytics
                </a>
                <span class="category-list-count">9</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/google-app-engine">
                    google-app-engine
                </a>
                <span class="category-list-count">4</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/google-auth">
                    google-auth
                </a>
                <span class="category-list-count">4</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/google-cloud-storage">
                    google-cloud-storage
                </a>
                <span class="category-list-count">4</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/google-compute-engine">
                    google-compute-engine
                </a>
                <span class="category-list-count">7</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/google-language">
                    google-language
                </a>
                <span class="category-list-count">2</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/google-tag-manager">
                    google-tag-manager
                </a>
                <span class="category-list-count">3</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/python">
                    python
                </a>
                <span class="category-list-count">5</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/rstudio-server">
                    rstudio-server
                </a>
                <span class="category-list-count">4</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="/tags/search-console">
                    search-console
                </a>
                <span class="category-list-count">3</span>
            </li>
            
        </ul>
    </div>
</div>




    


    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

    
	</div>
</div>

<footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020
      Powered by <a href="//gohugo.io">Hugo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>.
    </div>
  </div>
</footer>


<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script src="/js/script.js"></script>
<script src="/js/highlight.pack.js"></script>


<script>hljs.initHighlightingOnLoad();</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>




</body>
</html>