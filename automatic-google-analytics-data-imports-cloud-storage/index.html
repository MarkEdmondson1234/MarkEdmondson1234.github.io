<!DOCTYPE html>
<html lang="en-GB">
<head>
    <title>Auto Google Analytics Data Imports from Cloud Storage &middot; Mark Edmondson</title>
    <meta name="generator" content="Hugo 0.55.5" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="Mark Edmondson">
    
      <meta name="description" content="Use Google Cloud Functions to auto-load your data imports into Google Analytics form Cloud Storage">
    
    
    <link rel="canonical" href="https://code.markedmondson.me/automatic-google-analytics-data-imports-cloud-storage/"/>
    <link rel="icon" href="https://code.markedmondson.me/favicon.ico">
    <link rel="apple-touch-icon" href="https://code.markedmondson.me/apple-touch-icon.png"/>
    <link rel="stylesheet" href="https://code.markedmondson.me/css/style.css">
    <link rel="stylesheet" href="https://code.markedmondson.me/css/github.css" rel="stylesheet" id="theme-stylesheet">
    <link rel="stylesheet" href="https://code.markedmondson.me/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://code.markedmondson.me/fancybox/jquery.fancybox.css">
    
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
    <meta property="og:title" content="Auto Google Analytics Data Imports from Cloud Storage" />
<meta property="og:description" content="Use Google Cloud Functions to auto-load your data imports into Google Analytics form Cloud Storage" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://code.markedmondson.me/automatic-google-analytics-data-imports-cloud-storage/" />
<meta property="article:published_time" content="2018-11-29T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2018-11-29T00:00:00&#43;00:00"/>

    
    
<meta itemprop="name" content="Auto Google Analytics Data Imports from Cloud Storage">
<meta itemprop="description" content="Use Google Cloud Functions to auto-load your data imports into Google Analytics form Cloud Storage">


<meta itemprop="datePublished" content="2018-11-29T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-11-29T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1854">



<meta itemprop="keywords" content="google-cloud-storage,python,google-analytics,cloud-functions," />

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Auto Google Analytics Data Imports from Cloud Storage"/>
<meta name="twitter:description" content="Use Google Cloud Functions to auto-load your data imports into Google Analytics form Cloud Storage"/>
<meta name="twitter:site" content="@HoloMarkeD"/>

    
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://gtm2.markedmondson.me/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WFFMBH');</script>



    <script src="https://code.markedmondson.me/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>
<body>
<div class="container">


<div id="container">
	<header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="https://code.markedmondson.me/" id="logo">
          
          <i class="logo" style="background-image: url('https://code.markedmondson.me/images/greenhand.png')"></i>
          
          <span class="site-title">Mark Edmondson</span>
      </a>
      <nav id="main-nav">
          
          
          <a class="main-nav-link" href="https://code.markedmondson.me/">Home</a>
          
          
          
          
          
          

          
          <a class="main-nav-link" href="/r-packages/">My R Packages</a>
          

          
          
          
          
          <a class="main-nav-link" href="http://www.markedmondson.me/posts/">Non-code blog</a>
          
          
          
          <a class="main-nav-link" href="https://www.markedmondson.me/static/presentations/">Past Presentations</a>
          
          
      </nav>
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://code.markedmondson.me/images/gde_avatar.jpg"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
              <input type="search" name="q" class="search-form-input" placeholder="Search">
              <button type="submit" class="search-form-submit">
              </button>
              <input type="hidden" name="sitesearch" value="https://code.markedmondson.me/" />
         </form>
        </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tbody>
          <tr>
          
          
          <td><a class="main-nav-link" href="https://code.markedmondson.me/">Home</a></td>
          
          
          
          
          
          

          
          <td><a class="main-nav-link" href="/r-packages/">My R Packages</a></td>
          

          
          
          
          
          <td><a class="main-nav-link" href="http://www.markedmondson.me/posts/">Non-code blog</a></td>
          
          
          
          <td><a class="main-nav-link" href="https://www.markedmondson.me/static/presentations/">Past Presentations</a></td>
          
          
          <td>
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
          <input type="search" name="q" class="search-form-input" placeholder="Search">
          <input type="hidden" name="sitesearch" value="https://code.markedmondson.me/" />
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</header>

   	
   	<div class="outer">
   	
    	<aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      
      <img id="avatar" src="https://code.markedmondson.me/images/gde_avatar.jpg">
      
      <h2 id="name">Mark Edmondson</h2>
      <h3 id="title">Coding in digital analytics</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Copenhagen, Denmark</span>
      
          <a id="follow" href="https://github.com/MarkEdmondson1234">
              Follow
          </a>
      
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        31
        <span>Posts</span>
      </div>
      <div class="article-info-block">
        
          17
        
        <span>
            Tags
        </span>
      </div>
    </div>
    <div class="profile-block social-links">
      <table>
        <tr>
          
<td><a href="//github.com/MarkEdmondson1234" target="_blank" title="GitHub"><i class="fa fa-github"></i></a></td>























<td><a href="//youtube.com/MarkEdmondsonAtHome" target="_blank" title="YouTube"><i class="fa fa-youtube"></i></a></td>















<td><a href="//linkedin.com/in/markpeteredmondson" target="_blank" title="LinkedIn"><i class="fa fa-linkedin"></i></a></td>















<td><a href="//twitter.com/HoloMarkeD" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></td>


          <td><a href="https://code.markedmondson.me/index.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></td>
        </tr>
      </table>
    </div>
  </div>
</aside>

    

    <section id="main">
    
    <article id="page-undefined" class="article article-type-page" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
            <img src="https://code.markedmondson.me/banners/data-imports.jpg" class="article-banner">
        

        <header class="article-header">
    <a href="https://code.markedmondson.me/automatic-google-analytics-data-imports-cloud-storage/">
    <h1 class="article-title" itemprop="name">
        Auto Google Analytics Data Imports from Cloud Storage
    </h1>
    </a>
    <div class="article-meta">

        
        <div class="article-date">
            <i class="fa fa-calendar"></i>
            <time datetime="2018-11-29 00:00:00 &#43;0000 UTC" itemprop="datePublished">2018-11-29</time>
            &middot;
            1854
            words
            &middot;
            9
            minute read
        </div>
        
        

        
            
            
            <div class="article-category">
                <i class="fa fa-tags"></i>
                
                
                <a class="article-category-link" href="https://code.markedmondson.me/tags/google-cloud-storage">google-cloud-storage</a>
                &middot;
                
                
                <a class="article-category-link" href="https://code.markedmondson.me/tags/python">python</a>
                &middot;
                
                
                <a class="article-category-link" href="https://code.markedmondson.me/tags/google-analytics">google-analytics</a>
                &middot;
                
                
                <a class="article-category-link" href="https://code.markedmondson.me/tags/cloud-functions">cloud-functions</a>
                
                
            </div>
            
        
    </div>
</header>

        <div class="article-entry" itemprop="articleBody">
            

<p>Continuing my infatuation with cloud functions (see last post on using cloud functions to manipulate BigQuery exports) this is a post showing how to bring together various code examples out there so that you can easily upload custom data imports from a Google cloud storage bucket.</p>

<p>The code is available in this <a href="https://github.com/MarkEdmondson1234/google-analytics-cloud-functions">GitHub repo for useful cloud functions with Google Analytics</a></p>

<h2 id="extended-data-imports">Extended data imports</h2>

<p>Google Analytics offers various versions of uploads.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/leqMQK-cuwk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>This post is about the <a href="https://support.google.com/analytics/answer/6066725">user level extended-data imports</a>.</p>

<p>For these imports you can do historic and <a href="https://support.google.com/analytics/answer/6071511?hl=en&amp;ref_topic=6064627">query time</a> (if you are using GA360).</p>

<p>Historic data imports can&rsquo;t be changed once uploaded as they are joined with the data upon <strong>collection</strong>, so suits things like date of birth (which shouldn&rsquo;t change per user).</p>

<p>Query time imports join with the data at the time you <strong>request</strong> the data, so can be used for more dynamic data such as which segment that user is in at the time.  That data could be computed offline in your CRM database or similar, and then made available to Google Analytics so you can create segments for Google Ads or Google Optimize.  You can do a lot more interesting things with it, which is why its a GA360 feature.</p>

<h2 id="why-automate-uploads">Why automate uploads?</h2>

<p>You can upload the data manually via the Google Analytics web UI, but when it comes to query time imports that can change often, that could mean daily updates.  It also takes a few hours to be available, so the earlier you can do it the better.</p>

<p>Both these requirements make it a good fit for cloud functions, since you can create a trigger that will run as soon as the data is available (not on a schedule) and trigger on demand.</p>

<h2 id="why-use-google-cloud-storage">Why use Google Cloud Storage?</h2>

<p>Google Cloud Storage is a generic blob store of bytes that is very quick and can hold many TBs of data.  It has many APIs and integrations (including <a href="http://code.markedmondson.me/googleCloudStorageR/">googleCloudStorageR</a> ) with the rest of the Google Cloud Platform and beyond, and I treat it as the central backbone for all my data storage.<br />
The idea is if the Cloud Function can take care of the link between Cloud Storage and Google Analytics, then its flexible how that file arrives at Cloud Storage.  It could be an R script, a BigQuery extract or an Airflow DAG that puts the file in the bucket, but once its there you know it will be uploaded to Google Analytics.</p>

<h2 id="preparation">Preparation</h2>

<h3 id="create-the-google-analytics-custom-data-import">Create the Google Analytics custom data import</h3>

<p>Within the Google Analytics Web UI, you need to create the custom data import&rsquo;s specifications.  In this case it would be a user custom data upload, query time and you then specify the key you are joining with, along with which dimensions you want to populate for that user.  Usually these are custom dimensions you have also previously created.</p>

<p>Once created you should get a schema you will use to create the correct data, and a custom upload ID that you will use within the upload script.</p>

<h3 id="create-an-authentication-file">Create an authentication file</h3>

<p>To run the script, since it deals with Google Analytics you need to create a service authentication file the script can use to allow it access to upload data.  You don&rsquo;t normally need this if using Google cloud services such as BigQuery, as the authentication is baked in, but as Google Analytics is not a cloud product, in this case we do.</p>

<ol>
<li>Reuse or create a Google Cloud Project with billing enabled.</li>
<li>Service accounts can be created <a href="https://console.cloud.google.com/iam-admin/serviceaccounts/create">here</a></li>
<li>It does not need any GCP account permissions (we do that in next step when we add to GA)</li>
<li>Create a JSON key for that service account and download it somewhere safe calling it <code>auth.json</code></li>
<li>Copy the service email e.g. <code>ga-uploads@your-project.iam.gserviceaccount.com</code></li>
<li>Login to Google Analytics and add the user at Web Property level with <strong>Edit</strong> permissions.</li>
<li>Make sure the GCP project the service key is for has Analytics API access enabled.</li>
</ol>

<p>You should now be able to use the JSON auth file to authenticate with Google Analytics API.</p>

<h3 id="create-a-google-cloud-storage-bucket">Create a Google Cloud Storage bucket</h3>

<p>Now we will create a Google Cloud storage bucket, and upload the authentication file to it.  We do this instead of uploading the authentication file with the Cloud function, as it keeps the Cloud function generic enough you can use it for other accounts by just pointing at a different bucket when you deploy.</p>

<p>You create a bucket from <a href="https://console.cloud.google.com/storage/browser">here</a> once you have your Google Cloud Project.</p>

<p>Once you have your bucket upload the <code>auth.json</code> file to the bucket, and then create a folder within the bucket which is where your uploads will be delivered to,</p>

<h2 id="the-code">The code</h2>

<p>The code is available in this <a href="https://github.com/MarkEdmondson1234/google-analytics-cloud-functions">GitHub repo for useful cloud functions with Google Analytics</a> which you can clone, modify and use.</p>

<p>You will need to specify the <code>pip</code> requirements for your code in a <code>requirements.txt</code> file, but you don&rsquo;t have to actually upload the libraries as you do for say App Engine.  Cloud Functions will download them for you when you deploy.</p>

<p>Create a <code>requirements.txt</code> file with these pinned dependencies:</p>

<pre><code>google-api-python-client==1.7.4
google-cloud-storage==1.13.0
oauth2client==4.1.3
</code></pre>

<p>The full script to upload to Cloud functions after you fill in your details is below.  It should be saved to a file called <code>main.py</code></p>

<pre><code class="language-python">import logging
import base64
import json
import os
from urllib.error import HTTPError
from apiclient.discovery import build
from oauth2client.service_account import ServiceAccountCredentials
from apiclient.http import MediaFileUpload
from google.cloud import storage

# set these to your details
ACCOUNTID='123456'
WEBPROPERTYID='UA-123456-2'
CUSTOM_DATASOURCE_ID='data_source_id'
FOLDER='source_folder_in_gcs_bucket'

# save file to /tmp only as cloud functions only supports that to write to
def download_gcs_file(obj, to, bucket):
    client = storage.Client()
    bucket = client.get_bucket(bucket)
    blob = bucket.blob(obj)

    blob.download_to_filename(to)
    logging.debug('downloaded file {} to {}'.format(obj, to))

# needs an auth.json file as cloud auth not working for analytics requests
def get_ga_service(bucket):

    download_gcs_file('auth.json', '/tmp/auth.json', bucket)
    credentials = ServiceAccountCredentials.from_json_keyfile_name(
            '/tmp/auth.json',
            scopes=['https://www.googleapis.com/auth/analytics',
                    'https://www.googleapis.com/auth/analytics.edit'])

    # Build the service object.
    return build('analytics', 'v3', credentials=credentials, cache_discovery=False)

def upload_ga(obj_name, bucket):

    filename = '/tmp/{}'.format(os.path.basename(obj_name))

    download_gcs_file(obj_name, filename, bucket)

    analytics = get_ga_service(bucket)

    try:
      media = MediaFileUpload(filename,
                              mimetype='application/octet-stream',
                              resumable=False)

      daily_upload = analytics.management().uploads().uploadData(
          accountId=ACCOUNTID,
          webPropertyId=WEBPROPERTYID,
          customDataSourceId=CUSTOM_DATASOURCE_ID,
          media_body=media).execute()

      logging.info('Uploaded file: {}'.format(json.dumps(daily_upload)))

    except TypeError as error:
      # Handle errors in constructing a query.
      logging.error('There was an error in constructing your query : {}'.format(error))

    except HTTPError as error:
      # Handle API errors.
      logging.error('There was an API error : {} : {}'.format(error.resp.status, error.resp.reason))

    return

def gcs_to_ga(data, context):
    &quot;&quot;&quot;Background Cloud Function to be triggered by Pub/Sub subscription.
       This functions copies the triggering BQ table and copies it to an aggregate dataset.
    Args:
        data (dict): The Cloud Functions event payload.
        context (google.cloud.functions.Context): Metadata of triggering event.
    Returns:
        None; the output is written to Stackdriver Logging
    &quot;&quot;&quot;
    logging.info('Bucket: {} File: {} Created: {} Updated: {}'.format(data['bucket'],
                                                                      data['name'],
                                                                      data['timeCreated'],
                                                                      data['updated']))
    folder = FOLDER
    object_name = data['name']
    bucket = data['bucket']
    if object_name.startswith(folder):
      logging.info('File matches folder {}'.format(folder))

      upload_ga(object_name, bucket)
      
    return
</code></pre>

<p>A walk-through of the functions is below:</p>

<h3 id="handling-pub-sub-functions">Handling pub/sub functions</h3>

<p>This function is the main entry point of the code.  When a new file arrives on Google Cloud Storage, it creates a Pub/Sub trigger with the meta data of the file and sends it to the trigger we will create when we deploy.</p>

<p>The <code>FOLDER</code> variable is so you can limit the function triggering to just a specific folder on the Google Cloud Bucket.  This is convenient so you can make sure only upload files trigger the function, and not say the authentcation files.</p>

<pre><code class="language-python">def gcs_to_ga(data, context):
    &quot;&quot;&quot;Background Cloud Function to be triggered by Pub/Sub subscription.
       This functions copies the triggering BQ table and copies it to an aggregate dataset.
    Args:
        data (dict): The Cloud Functions event payload.
        context (google.cloud.functions.Context): Metadata of triggering event.
    Returns:
        None; the output is written to Stackdriver Logging
    &quot;&quot;&quot;
    logging.info('Bucket: {} File: {} Created: {} Updated: {}'.format(data['bucket'],
                                                                      data['name'],
                                                                      data['timeCreated'],
                                                                      data['updated']))
    folder = FOLDER
    object_name = data['name']
    bucket = data['bucket']
    if object_name.startswith(folder):
      logging.info('File matches folder {}'.format(folder))

      upload_ga(object_name, bucket)
      
    return
</code></pre>

<h3 id="downloading-files-from-google-cloud-storage">Downloading files from Google Cloud Storage</h3>

<p>This code reuses the authentication of the function and downloads the file to it.  It can only download to the <code>/tmp</code> folder of the Cloud Function.</p>

<pre><code class="language-python">def download_gcs_file(obj, to, bucket):
    client = storage.Client()
    bucket = client.get_bucket(bucket)
    blob = bucket.blob(obj)

    blob.download_to_filename(to)
    logging.debug('downloaded file {} to {}'.format(obj, to))
</code></pre>

<h3 id="creating-the-google-analytics-object">Creating the Google Analytics object</h3>

<p>This downloads the <code>auth.json</code> file from Cloud Storage, and uses it to create an authenticated session with Google Analytics:</p>

<pre><code class="language-python"># needs an auth.json file as cloud auth not working for analytics requests
def get_ga_service(bucket):

    download_gcs_file('auth.json', '/tmp/auth.json', bucket)
    credentials = ServiceAccountCredentials.from_json_keyfile_name(
            '/tmp/auth.json',
            scopes=['https://www.googleapis.com/auth/analytics',
                    'https://www.googleapis.com/auth/analytics.edit'])

    # Build the service object.
    return build('analytics', 'v3', credentials=credentials, cache_discovery=False)
</code></pre>

<h3 id="download-from-cloud-storage-and-upload-to-ga">Download from Cloud Storage and upload to GA</h3>

<p>This does the work of downloading the file and uploading again to GA.  It uses the variables defined at the start of the script to determine where to upload it, but you could modify this to use a configuration file or loop over several uploads.</p>

<p>Code is adapted from <a href="https://developers.google.com/analytics/devguides/config/mgmt/v3/mgmtReference/management/uploads/uploadData">here</a></p>

<pre><code class="language-python">def upload_ga(obj_name, bucket):

    filename = '/tmp/{}'.format(os.path.basename(obj_name))

    download_gcs_file(obj_name, filename, bucket)

    analytics = get_ga_service(bucket)

    try:
      media = MediaFileUpload(filename,
                              mimetype='application/octet-stream',
                              resumable=False)

      daily_upload = analytics.management().uploads().uploadData(
          accountId=ACCOUNTID,
          webPropertyId=WEBPROPERTYID,
          customDataSourceId=CUSTOM_DATASOURCE_ID,
          media_body=media).execute()

      logging.info('Uploaded file: {}'.format(json.dumps(daily_upload)))

    except TypeError as error:
      # Handle errors in constructing a query.
      logging.error('There was an error in constructing your query : {}'.format(error))

    except HTTPError as error:
      # Handle API errors.
      logging.error('There was an API error : {} : {}'.format(error.resp.status, error.resp.reason))

    return

</code></pre>

<h2 id="deployment">Deployment</h2>

<p>The full code above needs to be saved to a file called <code>main.py</code> and then put into the same folder as <code>requirements.txt</code>:</p>

<pre><code>-|
 |- main.py
 |- requirements.txt
</code></pre>

<p>You may need to then install the <code>gcloud beta</code> components to deploy the python.  See the <a href="https://cloud.google.com/functions/docs/quickstart">guide</a> here.</p>

<p>After you have it installed, browse to the folder holding your code in your console, and then issue the <code>gcloud</code> commands to deploy the files.  It takes around 2 mins.</p>

<p>You need to specify the function that will trigger.  In our case this is the function that receives the data, <code>def gcs_to_ga(data, context)</code>.  We also need to specify its a Python file, and what the trigger will be.</p>

<p>If the file to upload is big, then you may also need a bigger Cloud function instance than the default 256MB.  The max file size that can be uploaded to Google Analytics is 1GB, so the largest 2048MB cloud function should cover that - the <code>gcloud</code> below shows how to specify that size of function:</p>

<pre><code class="language-sh">gcloud functions deploy gcs_to_ga --runtime python37 \
                                  --trigger-resource your-bucket \
                                  --trigger-event google.storage.object.finalize \
                                  --region europe-west1 \
                                  --memory=2048MB
</code></pre>

<h2 id="summary">Summary</h2>

<p>Upon successful deployment, you should be able to monitor the function in the <a href="https://console.cloud.google.com/logs/viewer">logs</a>.  Each time you upload a file to your bucket into the right folder, it will start a job to upload that file to Google Analytics.</p>

<p>It can take a couple of hours for the data to appear within Google Analytics reports.</p>

<p>This is a nice example of some functional &ldquo;glue&rdquo; that uncouples how to upload to GA from the file creation itself.  For example, it could be BigQuery exports that are creating the file, but that can switch to Airflow if the data transformations to create the files get more complicated or need special considerations.  The code is only intended as a starting point for you to customise and adapt to your needs.</p>

        </div>
        <footer class="article-footer">
    <a data-url="https://code.markedmondson.me/automatic-google-analytics-data-imports-cloud-storage/" data-id="8d9d3ea9c4e9bc9478be4d9e22db2adb" class="article-share-link">
        <i class="fa fa-share"></i>
        Share
    </a>
    

    <script>
    (function ($) {
        
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
    </script>
</footer>

    </div>

    
<nav id="article-nav">
    
    <a href="https://code.markedmondson.me/bigquery-ga360-exports-cloud-functions/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">
          Older
      </strong>
      <div class="article-nav-title">Turning GA360 BigQuery exports into partitioned tables using Cloud Functions</div>
    </a>
    

    
    <a href="https://code.markedmondson.me/r-at-scale-on-google-cloud-platform/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">
          Newer
      </strong>
      <div class="article-nav-title">R at scale on the Google Cloud Platform</div>
    </a>
    
</nav>


</article>


<section id="comments">
    <div id="utterances_thread">
        <script src="https://utteranc.es/client.js"
    repo="MarkEdmondson1234/markedmondson.me-hugo"
    issue-term="pathname"
    label="comment"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
    </div>
</section>


    </section>

   	
    	<aside id="sidebar">
    
<div class="widget-wrap">
    <h3 class="widget-title">
        Recents
    </h3>
    <div class="widget">
        <ul id="recent-post">
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://code.markedmondson.me/writing-a-book/" class="thumbnail">
                    
                        <span style="background-image:url(https://code.markedmondson.me/banners/proto-book.png)" alt="Auto Google Analytics Data Imports from Cloud Storage" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-title"><a href="https://code.markedmondson.me/writing-a-book/" class="title">Why and How I&#39;m writing a GA4 book called &#39;Learning Google Analytics&#39; for O&#39;Reilly</a></p>
                    <p class="item-date">
                        <time datetime="2021-10-23 11:04:50 &#43;0100 &#43;0100" itemprop="datePublished">2021-10-23</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://code.markedmondson.me/googleanalyticsr-100-release/" class="thumbnail">
                    
                        <span style="background-image:url(https://code.markedmondson.me/banners/GA4-090.png)" alt="Auto Google Analytics Data Imports from Cloud Storage" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-title"><a href="https://code.markedmondson.me/googleanalyticsr-100-release/" class="title">googleAnalyticsR v1.0.0 - GA4 API, Automatic Shiny Dashboarding, Improved UI</a></p>
                    <p class="item-date">
                        <time datetime="2021-04-17 09:29:50 &#43;0100 &#43;0100" itemprop="datePublished">2021-04-17</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://code.markedmondson.me/edmondlytica/" class="thumbnail">
                    
                        <span style="background-image:url(https://code.markedmondson.me/banners/edmonlytica-shiny1.png)" alt="Auto Google Analytics Data Imports from Cloud Storage" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-title"><a href="https://code.markedmondson.me/edmondlytica/" class="title">Creating your own cookieless analytics tool with GTM Server Side, Cloud Run, BigQuery and Shiny</a></p>
                    <p class="item-date">
                        <time datetime="2021-03-21 09:29:50 &#43;0100 CET" itemprop="datePublished">2021-03-21</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://code.markedmondson.me/data-privacy-gtm/" class="thumbnail">
                    
                        <span style="background-image:url(https://code.markedmondson.me/banners/hawks-and-doves.jpg)" alt="Auto Google Analytics Data Imports from Cloud Storage" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-title"><a href="https://code.markedmondson.me/data-privacy-gtm/" class="title">Data Privacy Engineering with Google Tag Manager Server Side and Consent Mode</a></p>
                    <p class="item-date">
                        <time datetime="2020-11-27 09:29:50 &#43;0100 CET" itemprop="datePublished">2020-11-27</time>
                    </p>
                </div>
            </li>
            
            <li>
                <div class="item-thumbnail">
                    <a href="https://code.markedmondson.me/gtm-serverside-webhooks/" class="thumbnail">
                    
                        <span style="background-image:url(https://code.markedmondson.me/banners/gtm-serverside-events.png)" alt="Auto Google Analytics Data Imports from Cloud Storage" class="thumbnail-image"></span>
                    
                    </a>
                </div>
                <div class="item-inner">
                    
                    <p class="item-title"><a href="https://code.markedmondson.me/gtm-serverside-webhooks/" class="title">Using Google Tag Manager Server Side to Trigger Webhook Events</a></p>
                    <p class="item-date">
                        <time datetime="2020-09-04 12:50:50 &#43;0100 &#43;0100" itemprop="datePublished">2020-09-04</time>
                    </p>
                </div>
            </li>
            
        </ul>
    </div>
</div>


    
<div class="widget-wrap">
    <h3 class="widget-title">
        Donate
    </h3>
    <div class="widget">
       	<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="marked" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script>
       	<iframe src="https://github.com/sponsors/MarkEdmondson1234/button" title="Sponsor MarkEdmondson1234" height="35" width="116" style="border: 0;"></iframe>
    </div>
</div>


    
<div class="widget-wrap">
    <h3 class="widget-title">
        Get your GA4 history
    </h3>
    <script>
      function submitDL(value){
        dataLayer.push({'event':'ga4_email','ga4_email':value});
        document.getElementById('email').value = 'Submitted! See inbox'
      }
        
    </script>
    <div>
        <input type="email" name="email"  id="email"
          required 
          minlength="8"
          placeholder="you@email.com">
        <button 
          onclick="javascript:submitDL(document.getElementById('email').value);"
         >Send</button>
    </div>
</div>


    





    


<div class="widget-wrap">
    <h3 class="widget-title">
        Tags
    </h3>
    <div class="widget">
        <ul class="category-list">
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/r">
                    R
                </a>
                <span class="category-list-count">22</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/big-query">
                    big-query
                </a>
                <span class="category-list-count">6</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/blogging">
                    blogging
                </a>
                <span class="category-list-count">3</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/cloud-functions">
                    cloud-functions
                </a>
                <span class="category-list-count">4</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/cloud-run">
                    cloud-run
                </a>
                <span class="category-list-count">4</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/docker">
                    docker
                </a>
                <span class="category-list-count">9</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/firebase">
                    firebase
                </a>
                <span class="category-list-count">1</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/google-analytics">
                    google-analytics
                </a>
                <span class="category-list-count">12</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/google-app-engine">
                    google-app-engine
                </a>
                <span class="category-list-count">4</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/google-auth">
                    google-auth
                </a>
                <span class="category-list-count">4</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/google-cloud-storage">
                    google-cloud-storage
                </a>
                <span class="category-list-count">4</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/google-compute-engine">
                    google-compute-engine
                </a>
                <span class="category-list-count">7</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/google-language">
                    google-language
                </a>
                <span class="category-list-count">2</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/google-tag-manager">
                    google-tag-manager
                </a>
                <span class="category-list-count">7</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/python">
                    python
                </a>
                <span class="category-list-count">5</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/rstudio-server">
                    rstudio-server
                </a>
                <span class="category-list-count">4</span>
            </li>
            
            <li class="category-list-item">
                
                <a class="category-list-link" href="https://code.markedmondson.me/tags/search-console">
                    search-console
                </a>
                <span class="category-list-count">3</span>
            </li>
            
        </ul>
    </div>
</div>




    


    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

    
	</div>
</div>

<footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021
      Powered by <a href="//gohugo.io">Hugo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>.
    </div>
  </div>
</footer>


<script src="https://code.markedmondson.me/fancybox/jquery.fancybox.pack.js"></script>
<script src="https://code.markedmondson.me/js/script.js"></script>
<script src="https://code.markedmondson.me/js/highlight.pack.js"></script>


<script>hljs.initHighlightingOnLoad();</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>




</body>
</html>